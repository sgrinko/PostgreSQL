# PostgreSQL (Windows)
## Скрипты по созданию бэкапов и восстановлению из бэкапов
Структура каталогов
* Full_Backup

    скрипт создания полного бэкапа кластера
* WAL_Backup

    скрипт создания бэкапа WAL файлов кластера
* Settings

    настройки почты (файлы использующиеся скриптами)

* Upgrade

	Обновление на новую версию
	
### Full_Backup
Скрипт позволяет создать полный бэкап всего кластера (на основе pg_basebackup.exe).
Сначала создается бэкап на локальном устройстве, где предварительно сжимается архиватором 7-Zip.
Полученный файл бэкапа копируется на сетевое хранилище.
Предполагается, что полный бэкап кластера делается не чаще чем 1 раз в день.
* Logs

	Каталог для хранения лога работы (1 файл для 1-го дня.)
* backup_cluster.ps1

    Скрипт создания полного бэкапа кластера на языке PowerShell.

### WAL_Backup
Скрипт позволяет создать бэкап WAL файлов кластера.
Предполагается, что сервер заранее настроен на архивацию WAL файлов (archive_command ....)
Сначала создается бэкап всех текущих WAL файлов на локальном устройстве, где предварительно сжимается архиватором 7-Zip.
Полученный файл бэкапа копируется на сетевое хранилище.
При вызове этого скрипта чаще 1 раза в день будет происходить обновление ранее созданного архива за текущий день.
После успешной работы, файл за предыдущий день удаляется, так как в новом файле присутствуют все WAL файлы.
* Logs

	Каталог для хранения лога работы (1 файл для 1-го дня.)

* backup_WAL.ps1

    Скрипт создания бэкапа WAL файлов кластера на языке PowerShell.

### Settings
Здесь находятся файлы c настройками для почтовых параметров, которые используются скриптами указанными выше скриптами.
* mail_port.txt

    номер порта почтового сервера
* mail_smtp.txt

    имя почтового сервера
* mails.txt

    список Email ("User01 <user01@example.com>") которым необходимо отослать  письмо с ошибкой работы скрипта

### Upgrade
Обновление кластера с версии 9.4 до версии 9.5

Внутри каталога 2 cmd файла

* 1) upgrade_cluster.cmd
	
	этот файл вызывает 2-й под пользователем postgres который должен быть superuser кластера и еще в windows должен быть такой пользователь.

* 2) upgrade_cluster_process.cmd

	Во втором файле  в самом начале есть SETы в которых указываются пути к файлам данных и к бинарным файлам каждой версии.
	Это необходимо править в вашем конкретном случае.

Начальное состояние перед запуском ( стартовать 1-й файл):
- устанавливаем новую версию сервера на порт 5433 и в новый каталог (например D:\PostgresData_9.5)
предполагается, что ранее выполнена проверка на коррекцию опций в файле конфигураций postgresql.conf и такой файл уже подготовлен.
Положить его надо с именем postgresql_new.conf в корень каталога старой версии (9.4)

Что важно под windows - нужно, чтобы пользователь postgres (windows) имел полные права на всё содержимое каталогов с данными.

Теперь можно вызывать 1-й файл.
В самом конце вызывается vacuumdb для сбора статистики
